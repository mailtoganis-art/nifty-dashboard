<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nifty Pro Dashboard</title>

<style>
body{
  font-family:Arial;
  background:#0f172a;
  color:white;
  padding:20px;
}

.card{
  background:#1e293b;
  padding:15px;
  border-radius:10px;
  margin-bottom:15px;
}

.green{color:#22c55e}
.red{color:#ef4444}

button{
  width:100%;
  padding:12px;
  background:#2563eb;
  border:none;
  color:white;
  border-radius:8px;
}
</style>
</head>

<body>

<h2>NIFTY Pro Dashboard</h2>

<div class="card" id="market">Loading...</div>
<div class="card" id="vix">Loading VIX...</div>
<div class="card" id="biasBox">Loading Bias...</div>

<div class="card">
<h3>Market News</h3>
<div id="news"></div>
</div>

<button onclick="loadAll()">Refresh</button>

<script>

// ================= MASTER LOAD =================
async function loadAll(){
  loadMarket();
  loadVix();
  loadBias();
  loadNews();
}


// ================= MARKET =================
async function loadMarket(){
  try{
    const res = await fetch("/api/nifty");
    const data = await res.json();

    if (!data.marketLive) {
      document.getElementById("market").innerHTML =
        `<span style="color:#facc15">${data.message}</span>`;
      return;
    }

    const meta = data.data.chart.result[0].meta;
    const current = meta.regularMarketPrice;
    const prev = meta.previousClose;
    const change = (current - prev).toFixed(2);

    document.getElementById("market").innerHTML =
      `Current: ${current}<br>
       Change: <span class="${change>0?'green':'red'}">${change}</span>`;
  } catch(e){
    document.getElementById("market").innerHTML = "Error loading market";
  }
}


// ================= VIX =================
async function loadVix(){
  try{
    const res = await fetch("/api/vix");
    const data = await res.json();

    if (!data.marketLive) {
      document.getElementById("vix").innerHTML =
        `<span style="color:#facc15">${data.message}</span>`;
      return;
    }

    const vix = data.data.chart.result[0].meta.regularMarketPrice;
    document.getElementById("vix").innerHTML = "India VIX: " + vix;
  } catch(e){
    document.getElementById("vix").innerHTML = "Error loading VIX";
  }
}


// ================= BIAS =================
async function loadBias(){
  try{
    const res = await fetch("/api/bias");
    const data = await res.json();

    if (!data.marketLive) {
      document.getElementById("biasBox").innerHTML =
        `<span style="color:#facc15">${data.message}</span>`;
      return;
    }

    document.getElementById("biasBox").innerHTML =
      `<b>${data.bias}</b><br>
       Entry Level: ${data.entryLevel}<br>
       Current: ${data.current}`;
  } catch(e){
    document.getElementById("biasBox").innerHTML = "Error loading bias";
  }
}


// ================= NEWS =================
async function loadNews(){
  try{
    const res = await fetch("/api/news");
    const data = await res.json();

    let html = "";

    if (!data.articles || data.articles.length === 0) {
      html = "No news available.";
    } else {
      data.articles.slice(0,5).forEach(article => {
        html += `
          <div style="margin-bottom:10px">
            <a href="${article.url}" target="_blank" style="color:white;text-decoration:none">
              <b>${article.title}</b>
            </a>
            <br>
            <small style="opacity:0.7">${article.source.name}</small>
            <hr>
          </div>
        `;
      });
    }

    document.getElementById("news").innerHTML = html;
  } catch(e){
    document.getElementById("news").innerHTML = "Error loading news";
  }
}


// ================= AUTO REFRESH =================
setInterval(loadAll, 1000);

// Initial Load
loadAll();

</script>

</body>
</html>