<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nifty Intelligence Dashboard</title>

<style>
body{
  font-family:Arial;
  background:#0f172a;
  color:white;
  padding:20px;
}

.card{
  background:#1e293b;
  padding:15px;
  border-radius:10px;
  margin-bottom:15px;
}

.heading{
  font-size:18px;
  margin-bottom:8px;
  color:#60a5fa;
}

.green{color:#22c55e;font-weight:bold;}
.red{color:#ef4444;font-weight:bold;}
.yellow{color:#facc15;font-weight:bold;}

.biasBox{
  text-align:center;
  padding:20px;
  font-size:22px;
  border-radius:12px;
}

.callBox{background:#064e3b;}
.putBox{background:#7f1d1d;}
.waitBox{background:#374151;}

small{opacity:0.7;}
</style>
</head>

<body>

<h2>Nifty 15-Min Intelligence Engine</h2>

<div class="card" id="marketStatus"></div>

<div class="card">
  <div class="heading">ðŸ“Š Market Overview</div>
  <div id="market"></div>
  <div id="vix"></div>
</div>

<div class="card">
  <div class="heading">ðŸ“ˆ Trend & Momentum</div>
  <div id="trendDetails"></div>
</div>

<div class="card">
  <div class="heading">ðŸŽ¯ Final Decision</div>
  <div id="biasBox" class="biasBox waitBox">Loading...</div>
</div>

<div class="card">
  <div class="heading">ðŸ“° Latest Market News</div>
  <div id="news"></div>
</div>

<script>

// ================= LOAD ALL =================
async function loadAll(){
  loadMarket();
  loadBias();
  loadNews();
}


// ================= MARKET =================
async function loadMarket(){
  const res = await fetch("/api/nifty");
  const data = await res.json();

  if (!data.marketLive) {
    document.getElementById("marketStatus").innerHTML =
      `<span class="yellow">${data.message}</span>`;
    document.getElementById("market").innerHTML="";
    document.getElementById("vix").innerHTML="";
    return;
  }

  document.getElementById("marketStatus").innerHTML =
    `<span class="green">Market Live</span>`;

  const meta = data.data.chart.result[0].meta;
  const current = meta.regularMarketPrice;
  const prev = meta.previousClose;
  const change = (current - prev).toFixed(2);

  document.getElementById("market").innerHTML =
    `Nifty Current: ${current} 
     <br>Change: <span class="${change>0?'green':'red'}">${change}</span>`;

  // VIX
  const vixRes = await fetch("/api/vix");
  const vixData = await vixRes.json();

  if (vixData.marketLive) {
    const vix = vixData.data.chart.result[0].meta.regularMarketPrice;
    document.getElementById("vix").innerHTML =
      `India VIX: ${vix}`;
  }
}


// ================= BIAS =================
async function loadBias(){
  const res = await fetch("/api/bias");
  const data = await res.json();

  if (!data.marketLive) {
    document.getElementById("biasBox").className="biasBox waitBox";
    document.getElementById("biasBox").innerHTML =
      `<span class="yellow">${data.message}</span>`;
    return;
  }

  let boxClass="waitBox";
  let colorClass="yellow";

  if (data.bias.includes("CALL")) {
    boxClass="callBox";
    colorClass="green";
  } 
  else if (data.bias.includes("PUT")) {
    boxClass="putBox";
    colorClass="red";
  }

  document.getElementById("biasBox").className="biasBox " + boxClass;

  document.getElementById("biasBox").innerHTML =
    `<div class="${colorClass}">${data.bias}</div>
     <small>Entry Level: ${data.entryLevel || "Wait Breakout"}</small>
     <br><small>Current Price: ${data.current}</small>`;

  document.getElementById("trendDetails").innerHTML =
    `Bias Confidence: ${data.confidence || 50}%`;
}


// ================= NEWS =================
async function loadNews(){
  const res = await fetch("/api/news");
  const data = await res.json();

  let html="";
  if (data.articles) {
    data.articles.slice(0,3).forEach(article=>{
      html+=`<div>
        <b>${article.title}</b><br>
        <small>${article.source.name}</small>
        <hr>
      </div>`;
    });
  }
  document.getElementById("news").innerHTML=html;
}


// Auto Refresh every 5 seconds
setInterval(loadAll, 5000);

loadAll();

</script>

</body>
</html>