<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nifty 15-Min Intelligence Engine</title>

<style>
body{
  font-family:Arial;
  background:#0f172a;
  color:white;
  padding:20px;
}

.card{
  background:#1e293b;
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
}

.green{color:#22c55e;}
.red{color:#ef4444;}
.yellow{color:#facc15;}

.highlight{
  font-size:22px;
  font-weight:bold;
  text-align:center;
  padding:15px;
  border-radius:10px;
  margin-top:10px;
}

button{
  width:100%;
  padding:12px;
  background:#2563eb;
  border:none;
  color:white;
  border-radius:8px;
}
</style>
</head>

<body>

<h2>Nifty 15-Min Intelligence Engine</h2>

<div class="card" id="marketStatus"></div>

<div class="card">
  <h3>ðŸ“Š Market Overview</h3>
  <div id="market">Loading...</div>
  <div id="vix">Loading VIX...</div>
</div>

<div class="card">
  <h3>ðŸ“ˆ Trend & Momentum</h3>
  <div id="trendBox">Loading...</div>
</div>

<div class="card">
  <h3>ðŸŽ¯ Final Decision</h3>
  <div id="finalDecision">Loading...</div>
</div>

<div class="card">
  <h3>ðŸ“° Latest Market News</h3>
  <div id="news">Loading...</div>
</div>

<button onclick="loadAll()">Refresh Now</button>

<script>

function isMarketHours() {
  const now = new Date();
  const day = now.getDay();
  const hour = now.getHours();
  const min = now.getMinutes();
  const current = hour * 60 + min;
  return day !== 0 && day !== 6 && current >= 555 && current <= 930;
}

async function loadAll(){
  if(!isMarketHours()){
    document.getElementById("marketStatus").innerHTML =
      `<div class="yellow"><b>Market Closed (Weekend or Outside Trading Hours)</b></div>`;
  } else {
    document.getElementById("marketStatus").innerHTML =
      `<div class="green"><b>Market Live</b></div>`;
  }

  loadMarket();
  loadVix();
  loadNews();
  loadIntelligence();
}

async function loadMarket(){
  const res = await fetch("/api/nifty");
  const data = await res.json();

  const meta = data.chart.result[0].meta;
  const current = meta.regularMarketPrice;
  const prev = meta.previousClose;
  const change = (current - prev).toFixed(2);

  document.getElementById("market").innerHTML =
    `Current: ${current}<br>
     Change: <span class="${change>0?'green':'red'}">${change}</span>`;
}

async function loadVix(){
  const res = await fetch("/api/vix");
  const data = await res.json();
  const vix = data.chart.result[0].meta.regularMarketPrice;
  document.getElementById("vix").innerHTML =
    `India VIX: ${vix}`;
}

async function loadNews(){
  const res = await fetch("/api/news");
  const data = await res.json();

  let html = "";

  if (!data.articles || data.articles.length === 0) {
    html = "No news available.";
  } else {
    data.articles.slice(0,5).forEach(article => {
      html += `
        <div style="margin-bottom:10px">
          <a href="${article.url}" target="_blank" style="color:white;text-decoration:none">
            <b>${article.title}</b>
          </a>
          <br>
          <small style="opacity:0.7">${article.source.name}</small>
          <hr>
        </div>
      `;
    });
  }

  document.getElementById("news").innerHTML = html;
}

async function loadIntelligence(){
  const res = await fetch("/api/intelligence");
  const data = await res.json();

  if(data.marketStatus === "CLOSED"){
    document.getElementById("finalDecision").innerHTML =
      `<div class="highlight yellow">${data.message}</div>`;
    document.getElementById("trendBox").innerHTML = "-";
    return;
  }

  document.getElementById("trendBox").innerHTML =
    `Momentum Score: ${data.momentumScore}<br>
     Trend Strength: ${data.trendStrength}`;

  const color = data.signal === "CALL" ? "green" : "red";

  document.getElementById("finalDecision").innerHTML =
    `<div class="highlight ${color}">
        ${data.signal} SIDE<br>
        Confidence: ${data.confidence}%<br>
        Entry Level: ${data.entry}
     </div>`;
}

setInterval(loadAll, 15000); // auto refresh every 15 sec
loadAll();

</script>

</body>
</html>